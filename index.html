<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Global Territory Manager</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #111; color: #eee; overflow: hidden; height: 100vh; }
        #top-nav { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 1000; width: 400px; background: #222; padding: 10px; border-radius: 8px; border: 1px solid #444; }
        #search-input { width: 100%; padding: 10px; background: #111; border: 1px solid #555; color: white; border-radius: 4px; box-sizing: border-box; }
        #search-results { max-height: 200px; overflow-y: auto; background: #111; border-radius: 4px; margin-top: 5px; display: none; border: 1px solid #444; }
        .search-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #222; }
        .search-item:hover { background: #3498db; }
        #sidebar { position: absolute; left: 10px; top: 80px; bottom: 10px; width: 260px; background: rgba(34, 34, 34, 0.9); padding: 15px; z-index: 1000; border-radius: 8px; border: 1px solid #444; display: flex; flex-direction: column; }
        .panel { background: #333; padding: 10px; border-radius: 6px; margin-bottom: 10px; }
        h4 { margin: 0 0 8px 0; color: #3498db; font-size: 0.7rem; text-transform: uppercase; }
        .popup-menu { color: white; min-width: 150px; }
        .popup-menu select { width: 100%; padding: 5px; margin-top: 10px; background: #111; color: white; border: 1px solid #555; }
        .popup-btn { background: #27ae60; color: white; border: none; padding: 8px; width: 100%; margin-top: 10px; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .leaflet-popup-content-wrapper { background: #222; color: white; border: 1px solid #444; }
        #map { height: 100vh; width: 100vw; background: #1a1a1a; }
        .board-row { display: flex; justify-content: space-between; font-size: 0.8rem; padding: 3px 0; }
    </style>
</head>
<body>

<div id="top-nav">
    <input type="text" id="search-input" placeholder="üîç Search country..." onkeyup="doSearch()">
    <div id="search-results"></div>
</div>

<div id="sidebar">
    <div class="panel">
        <h4>Leaderboard</h4>
        <div id="leaderboard"></div>
    </div>
    <div class="panel">
        <h4>Add Person</h4>
        <input type="text" id="new-name" placeholder="Name..." style="width:100%; background:#111; color:white; border:1px solid #555; padding:5px; margin-bottom:5px;">
        <input type="color" id="new-color" value="#e74c3c" style="width:100%; height:30px; border:none; cursor:pointer;">
        <button onclick="addGroup()" style="width:100%; background:#3498db; color:white; border:none; padding:8px; margin-top:5px; border-radius:4px; cursor:pointer;">Add</button>
    </div>
    <button onclick="clearData()" style="margin-top:auto; background:#c0392b; color:white; border:none; padding:8px; border-radius:4px; cursor:pointer;">Reset Map</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@vlad_vovk/world-geojson-low@1.0.1/dist/world.js"></script>

<script>
    const countries = ["Afghanistan", "Albania", "Algeria", "Angola", "Antarctica", "Argentina", "Armenia", "Australia", "Austria", "Azerbaijan", "Bahamas", "Bangladesh", "Belarus", "Belgium", "Belize", "Benin", "Bhutan", "Bolivia", "Bosnia and Herz.", "Botswana", "Brazil", "Brunei", "Bulgaria", "Burkina Faso", "Burundi", "Cambodia", "Cameroon", "Canada", "Central African Rep.", "Chad", "Chile", "China", "Colombia", "Congo", "Costa Rica", "Croatia", "Cuba", "Cyprus", "Czechia", "C√¥te d'Ivoire", "Dem. Rep. Congo", "Denmark", "Djibouti", "Dominican Rep.", "Ecuador", "Egypt", "El Salvador", "Eq. Guinea", "Eritrea", "Estonia", "Ethiopia", "Falkland Is.", "Fiji", "Finland", "France", "Gabon", "Gambia", "Georgia", "Germany", "Ghana", "Greece", "Greenland", "Guatemala", "Guinea", "Guinea-Bissau", "Guyana", "Haiti", "Honduras", "Hungary", "Iceland", "India", "Indonesia", "Iran", "Iraq", "Ireland", "Israel", "Italy", "Jamaica", "Japan", "Jordan", "Kazakhstan", "Kenya", "Kuwait", "Kyrgyzstan", "Laos", "Latvia", "Lebanon", "Lesotho", "Liberia", "Libya", "Lithuania", "Luxembourg", "Madagascar", "Malawi", "Malaysia", "Mali", "Mauritania", "Mexico", "Moldova", "Mongolia", "Montenegro", "Morocco", "Mozambique", "Myanmar", "Namibia", "Nepal", "Netherlands", "New Caledonia", "New Zealand", "Nicaragua", "Niger", "Nigeria", "North Korea", "North Macedonia", "Norway", "Oman", "Pakistan", "Palestine", "Panama", "Papua New Guinea", "Paraguay", "Peru", "Philippines", "Poland", "Portugal", "Puerto Rico", "Qatar", "Romania", "Russia", "Rwanda", "Saudi Arabia", "Senegal", "Serbia", "Sierra Leone", "Slovakia", "Slovenia", "Solomon Is.", "Somalia", "South Africa", "South Korea", "South Sudan", "Spain", "Sri Lanka", "Sudan", "Suriname", "Sweden", "Switzerland", "Syria", "Taiwan", "Tajikistan", "Tanzania", "Thailand", "Timor-Leste", "Togo", "Trinidad and Tobago", "Tunisia", "Turkey", "Turkmenistan", "Uganda", "Ukraine", "United Arab Emirates", "United Kingdom", "United States of America", "Uruguay", "Uzbekistan", "Vanuatu", "Venezuela", "Vietnam", "W. Sahara", "Yemen", "Zambia", "Zimbabwe"];

    let mapData = JSON.parse(localStorage.getItem('map_v14_data')) || {};
    let groups = JSON.parse(localStorage.getItem('map_v14_groups')) || [{name: "Unassigned", color: "#888"}];
    let geoLayer;

    const map = L.map('map', { zoomControl: false }).setView([20, 0], 2);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

    function getStyle(f) {
        const d = mapData[f.properties.name];
        return { fillColor: d ? d.color : '#333', weight: 1, color: '#444', fillOpacity: 0.8 };
    }

    function init() {
        if (typeof world !== 'undefined') {
            geoLayer = L.geoJson(world, {
                style: getStyle,
                onEachFeature: (f, l) => {
                    l.on('click', (e) => openCountryMenu(f.properties.name, e.latlng));
                }
            }).addTo(map);
            updateUI();
        } else { setTimeout(init, 500); }
    }

    function doSearch() {
        const term = document.getElementById('search-input').value.toLowerCase();
        const res = document.getElementById('search-results');
        if (!term) { res.style.display = 'none'; return; }
        const filtered = countries.filter(c => c.toLowerCase().includes(term));
        res.innerHTML = filtered.map(c => `<div class="search-item" onclick="selectFromSearch('${c.replace(/'/g, "\\'")}')">${c}</div>`).join('');
        res.style.display = 'block';
    }

    function selectFromSearch(name) {
        document.getElementById('search-input').value = name;
        document.getElementById('search-results').style.display = 'none';
        
        geoLayer.eachLayer(l => {
            if (l.feature.properties.name === name) {
                const center = l.getBounds().getCenter();
                map.flyTo(center, 4);
                // Delay menu opening until flyTo finishes
                setTimeout(() => openCountryMenu(name, center), 500);
            }
        });
    }

    function openCountryMenu(name, latlng) {
        const current = mapData[name] ? mapData[name].name : "Unassigned";
        const options = groups.map(g => `<option value="${g.name}" ${g.name === current ? 'selected' : ''}>${g.name}</option>`).join('');
        const content = `<div class="popup-menu"><b>${name}</b><br><small>Owner: ${current}</small><select id="pop-sel">${options}</select><button class="popup-btn" onclick="saveAssignment('${name.replace(/'/g, "\\'")}')">Save</button></div>`;
        L.popup().setLatLng(latlng).setContent(content).openOn(map);
    }

    function saveAssignment(name) {
        const groupName = document.getElementById('pop-sel').value;
        const groupObj = groups.find(g => g.name === groupName);
        if (groupName === "Unassigned") delete mapData[name];
        else mapData[name] = { name: groupObj.name, color: groupObj.color };
        updateUI();
        map.closePopup();
    }

    function updateUI() {
        const counts = {};
        Object.values(mapData).forEach(v => counts[v.name] = (counts[v.name] || 0) + 1);
        const sorted = [...groups].filter(g => g.name !== "Unassigned").sort((a,b) => (counts[b.name]||0) - (counts[a.name]||0));
        document.getElementById('leaderboard').innerHTML = sorted.map(g => `<div class="board-row"><span><span style="color:${g.color}">‚óè</span> ${g.name}</span><b>${counts[g.name] || 0}</b></div>`).join('');
        localStorage.setItem('map_v14_data', JSON.stringify(mapData));
        localStorage.setItem('map_v14_groups', JSON.stringify(groups));
        if (geoLayer) geoLayer.setStyle(getStyle);
    }

    function addGroup() {
        const name = document.getElementById('new-name').value.trim();
        if (name) {
            groups.push({ name, color: document.getElementById('new-color').value });
            document.getElementById('new-name').value = '';
            updateUI();
        }
    }

    function clearData() { if(confirm("Reset all?")) { localStorage.clear(); location.reload(); } }
    init();
</script>
</body>
</html>
